{% for option in product.options %}

  {%- liquid
    assign option_handle = option | handle
    assign option_index = forloop.index0
  -%}

  {% capture downcased_option %}{{ option | downcase }}{% endcapture %}
  {% assign color_swatch_options = settings.swatch_option_names | replace: ' ,', ',' | replace: ', ', ',' | split: ',' | downcase %}
  {%  if color_swatch_options contains downcased_option %}
    <div class="col-swatch">
      <ul data-option-index="{{ option_index }}" class="{{ option_handle }} options">
        {% assign values = '' %}
        {% assign color_count = 0 %}
        {% assign total_colors = 0 %}

        {% for variant in product.variants %}
          {% assign value = variant.options[option_index] %}
          {% capture wrapped_value %},{{ value }},{% endcapture %}
          {% unless values contains wrapped_value %}
            {% assign total_colors = total_colors | plus: 1 %}

            {%- liquid
              if value.swatch.color and settings.color_swatch_style == 'swatch'
                assign css_color = value.swatch.color
              else
                assign css_color = value | split: ' ' | last | handle
              endif
              assign image_url = value | handle | append: '.png' | file_url
              assign variant_image_url = blank
              if variant.image
                assign variant_image_url =  variant.image | image_url: width: 80
              endif
            -%}

            {% if color_count < 4 %}
              <li data-option-title="{{ value | escape }}" data-href="{{ variant.featured_media | image_url: width: 800 }}" class="color {{ value | handle }}">
                <a href="{{ variant.url | within: collection }}">
                  {% if settings.color_swatch_style == 'variant-image' and variant_image_url != blank %}
                      {{ variant.image | image_url: width: 80 | image_tag: class: 'variant-image', alt: value }}
                  {%  elsif settings.color_swatch_style == 'swatch' and value.swatch.image %}
                     {{ value.swatch.image | image_url: width: 50 | image_tag: class: 'swatch-image', alt: value }}
                  {% else %}
                    {%- liquid
                      assign show_custom_image = false
                      assign bg_image_rule = blank
                      if settings.color_swatch_style == 'custom-image' and image_url != blank
                        assign show_custom_image = true
                        assign bg_image_rule = "background-image: url(" | append: image_url | append: ");"
                      endif
                    -%}
                    <span class="custom-image css-color" style="width: 20px; height: 20px; background-color: {{ css_color }};{% if show_custom_image %}{{ bg_image_rule }}{% endif %}"></span>
                  {% endif %}
                </a>
              </li>
              {% assign color_count = color_count | plus: 1 %}
            {% endif %}

            {% capture values %}{{ values }}{{ wrapped_value }}{% endcapture %}
          {% endunless %}
        {% endfor %}

        {% if total_colors > 4 %}
          <li><a href="{{ product.url }}">+{{ total_colors | minus: 4 }} {{ 'collections.general.more' | t }}</a></li>
        {% endif %}
      </ul>
    </div><!-- .swatch -->
  {% endif %}
{% endfor %}
